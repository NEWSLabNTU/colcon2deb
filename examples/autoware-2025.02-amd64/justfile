# Autoware 2025.02 AMD64 Debian Package Builder

# Default recipe: list all available recipes
default:
    @just --list

# Build Debian packages for Autoware 2025.02
build:
    #!/usr/bin/env bash
    set -e

    SCRIPT_DIR="{{justfile_directory()}}"
    SOURCE_DIR="${SCRIPT_DIR}/source"
    PROJECT_ROOT="$(cd "${SCRIPT_DIR}/../.." && pwd)"

    echo "=== Building Autoware 2025.02 AMD64 Debian packages ==="

    # Check if source directory exists
    if [ ! -d "${SOURCE_DIR}" ]; then
        echo "Error: Source directory not found at ${SOURCE_DIR}"
        echo "Please prepare the Autoware workspace first. See README.md for instructions."
        exit 1
    fi

    # Check if source has packages (at least some package.xml files)
    PACKAGE_COUNT=$(find "${SOURCE_DIR}/src" -name "package.xml" 2>/dev/null | wc -l)
    if [ "${PACKAGE_COUNT}" -eq 0 ]; then
        echo "Error: No ROS packages found in ${SOURCE_DIR}/src"
        echo "Please import dependencies first. See README.md for instructions."
        echo ""
        echo "Quick start:"
        echo "  cd ${SOURCE_DIR}"
        echo "  vcs import src < autoware.repos"
        exit 1
    fi

    echo "Found ${PACKAGE_COUNT} ROS packages in source directory"

    # Check if colcon2deb is available
    if command -v colcon2deb &> /dev/null; then
        COLCON2DEB="colcon2deb"
    elif [ -f "${PROJECT_ROOT}/.venv/bin/colcon2deb" ]; then
        echo "Using colcon2deb from project venv..."
        COLCON2DEB="${PROJECT_ROOT}/.venv/bin/colcon2deb"
    else
        echo "Error: colcon2deb is not available."
        echo "Please install it first:"
        echo "  cd ${PROJECT_ROOT}"
        echo "  uv sync  # Install dependencies"
        exit 1
    fi

    # Run colcon2deb
    echo "Running colcon2deb..."
    cd "${SCRIPT_DIR}"
    "${COLCON2DEB}" --workspace "${SOURCE_DIR}" --config config.yaml

    echo "=== Build complete ==="
    echo "Debian packages are available in: ${SCRIPT_DIR}/build/"

# Clean build artifacts
clean:
    @echo "Cleaning build directory..."
    rm -rf build/
    @echo "✓ Clean complete"

# Rebuild Docker image
rebuild-image:
    @echo "Rebuilding Docker image..."
    docker build -t autoware-2025.02-builder .
    @echo "✓ Docker image rebuilt"

# Clean and rebuild everything
rebuild: clean rebuild-image build
