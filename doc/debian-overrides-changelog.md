# Debian Overrides Changelog

This document describes the debian-override directories and their purpose, to aid in manual recreation after switching to the template system.

## Overview

The debian-override directories contain complete Debian package metadata for Autoware packages. These were originally generated by bloom-generate and then manually modified to work with the colcon2deb build system.

## Locations

- `examples/autoware-0.45.1-amd64/debian-overrides/` - 411 packages
- `examples/autoware-2025.02-amd64/debian-overrides/` - 419 packages

## Structure

Each package override contains a complete `debian/` directory:

```
<package_name>/
└── debian/
    ├── changelog      # Package version history
    ├── compat         # Debhelper compatibility level
    ├── control        # Package metadata and dependencies
    ├── copyright      # License information
    ├── rules          # Build rules (PRIMARY MODIFICATION)
    └── source/
        ├── format     # Source format specification
        └── options    # dpkg-source options
```

## Primary Modifications

### 1. Hardcoded Install Paths in debian/rules

**All debian/rules files have `/opt/ros/humble` hardcoded in multiple locations:**

- Line ~16: `export PKG_CONFIG_PATH=/opt/ros/humble/lib/pkgconfig`
- Line ~33: `if [ -f "/opt/ros/humble/setup.sh" ]; then . "/opt/ros/humble/setup.sh"; fi`
- Line ~35-37: CMAKE install/prefix paths set to `/opt/ros/humble`
- Line ~44, ~52, ~59, ~66: Additional setup.sh sourcing from `/opt/ros/humble`
- Line ~60: `dh_shlibdeps -l$(CURDIR)/debian/<package>//opt/ros/humble/lib/...`

**Example from agnocast_e2e_test/debian/rules:**

```makefile
export PKG_CONFIG_PATH=/opt/ros/humble/lib/pkgconfig

override_dh_auto_configure:
	if [ -f "/opt/ros/humble/setup.sh" ]; then . "/opt/ros/humble/setup.sh"; fi && \
	dh_auto_configure -- \
		-DCMAKE_INSTALL_PREFIX="/opt/ros/humble" \
		-DAMENT_PREFIX_PATH="/opt/ros/humble" \
		-DCMAKE_PREFIX_PATH="/opt/ros/humble" \
		$(BUILD_TESTING_ARG)
```

### 2. Package-Specific Dependencies in debian/control

The `debian/control` files may contain manually-tuned dependencies that were adjusted to fix build or runtime issues. These are package-specific and should be reviewed when recreating.

### 3. Version History in debian/changelog

The `debian/changelog` files contain complete version history for each package, including:
- Version numbers
- Timestamps
- Maintainer information
- Change descriptions with issue references

This history should be preserved when recreating overrides.

## Reason for Overrides

These overrides exist because:

1. **Initial setup**: Generated by bloom-generate for each package in Autoware
2. **Path hardcoding**: Required `/opt/ros/humble` to be explicitly set for the build system
3. **Dependency fixes**: Some packages needed manual dependency adjustments
4. **Build workarounds**: Various build issues were resolved through rule modifications

## Migration to Template System

The new template system (`templates/debian/rules.em`) provides the same functionality with parameterized paths:

**Template advantages:**
- Uses `@(InstallationPrefix)` bloom variable (set via bloom.conf)
- Uses `$(ROS_INSTALL_PREFIX)` makefile variable for runtime flexibility
- Eliminates hardcoded paths
- Supports custom installation directories

**Migration approach:**

1. Delete all existing debian-overrides
2. Configure colcon2deb to use custom install prefix in config.yaml:
   ```yaml
   build:
     install_prefix: "/opt/ros/humble"  # or custom path
   ```
3. Run colcon2deb to regenerate packages using the template
4. For problematic packages that fail, manually create overrides:
   - Copy generated debian/ directory
   - Apply necessary fixes to debian/control or debian/rules
   - Document the fix in this file

## Known Problematic Packages

(This section should be updated as packages are recreated and issues are discovered)

### Category: Build Issues
- TBD after regeneration

### Category: Dependency Issues
- TBD after regeneration

### Category: Special Build Rules
- TBD after regeneration

## Preserving Manual Fixes

When recreating overrides for problematic packages:

1. **Review old override**: Check what was manually changed from bloom default
2. **Try template first**: Let bloom generate with new template
3. **Apply minimal fixes**: Only override if template doesn't work
4. **Document here**: Add entry explaining what was fixed and why

## Template Variables

The new template uses these bloom/EmPy variables:

- `@(InstallationPrefix)` - Set via bloom.conf, defaults from ROS_INSTALL_PREFIX env
- `@(Package)` - Package name (e.g., "ros-humble-agnocast-e2e-test")
- `@(Name)` - Package name without dashes (e.g., "agnocast_e2e_test")

## References

- Template location: `templates/debian/rules.em`
- Bloom documentation: http://wiki.ros.org/bloom
- Generator script: `helper/generate-debian-dir.sh`
